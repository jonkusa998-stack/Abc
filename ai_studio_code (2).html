<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>School Cloud 4.0</title>
    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú TELEGRAM API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #121212;
            --surface: #242424;
            --primary: #8774e1; 
            --secondary: #00bfa5;
            --error: #ff5252;
            --text: #ffffff;
            --max-w: 500px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f0f0f; 
            color: var(--text);
            margin: 0; padding: 0;
            display: flex; justify-content: center; min-height: 100vh;
        }

        #app-container {
            width: 100%; max-width: var(--max-w);
            background-color: var(--bg); position: relative;
            min-height: 100vh; padding-bottom: 90px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* LOADING SCREEN */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg); z-index: 999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI COMPONENTS */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; max-width: var(--max-w);
            height: 65px; background: var(--surface);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #333; z-index: 100;
        }
        .nav-item { flex: 1; text-align: center; padding: 5px; color: #777; font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: scale(1.1); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }

        .section { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--surface); border-radius: 14px; padding: 16px;
            margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* HEADER & GRADES */
        .subj-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .subj-name { font-size: 17px; font-weight: 600; }
        .subj-avg { font-size: 20px; font-weight: 700; color: var(--primary); }
        
        .grades-grid { display: flex; flex-wrap: wrap; gap: 6px; margin: 12px 0; }
        .grade-chip {
            width: 32px; height: 32px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 16px; color: #000; cursor: pointer;
        }
        .val-2 { background: var(--error); color: white; }
        .val-3 { background: #ffab00; }
        .val-4 { background: #76ff03; }
        .val-5 { background: #00e676; }
        .val-0 { background: #555; color: white; border: 1px solid #777; }

        .btn {
            background: #333; color: white; border: none; padding: 12px;
            border-radius: 10px; font-weight: 500; font-size: 14px;
            width: 100%; cursor: pointer; margin-top: 5px;
        }
        .btn:active { background: var(--primary); }
        .btn-danger { color: var(--error); background: rgba(255, 82, 82, 0.1); }

        .floating-fab {
            position: fixed; bottom: 80px; right: calc(50% - var(--max-w)/2 + 20px);
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white; font-size: 30px;
            border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 90;
        }
        @media (max-width: 500px) { .floating-fab { right: 20px; } }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; display: none;
            justify-content: center; align-items: flex-end;
        }
        .modal {
            background: #1e1e1e; width: 100%; max-width: var(--max-w);
            border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .num-btn { height: 50px; border-radius: 12px; background: #333; border: none; color: white; font-size: 18px; font-weight: bold; }
        
        /* SYNC STATUS */
        #sync-status {
            text-align: center; font-size: 12px; color: #666; margin-top: 20px;
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="color:#888">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Telegram...</div>
</div>

<div id="app-container">
    
    <!-- HOME -->
    <div id="sec-home" class="section active">
        <div id="subjects-container"></div>
        <div id="sync-status">–û–±–ª–∞–∫–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ ‚óè</div>
    </div>

    <!-- SETTINGS (Simplified for Cloud) -->
    <div id="sec-settings" class="section">
        <h2>–ú–µ–Ω—é</h2>
        <div class="card">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
            <p style="font-size:12px; color:#888">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ Telegram –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.</p>
            <button class="btn" onclick="forceSync()">üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn btn-danger" onclick="wipeCloud()">üóë –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑ –æ–±–ª–∞–∫–∞</button>
        </div>
    </div>

    <button class="floating-fab" id="fab-add" onclick="addSubject()">+</button>

    <!-- NAVBAR -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('home', this)"><span class="nav-icon">üìö</span>–£—Ä–æ–∫–∏</div>
        <div class="nav-item" onclick="nav('settings', this)"><span class="nav-icon">‚öôÔ∏è</span>–ú–µ–Ω—é</div>
    </div>
</div>

<!-- MODAL ADD GRADE -->
<div class="modal-overlay" id="m-grade" onclick="if(event.target===this) closeM('m-grade')">
    <div class="modal">
        <h3>–û—Ü–µ–Ω–∫–∞</h3>
        <div class="num-grid">
            <button class="num-btn val-2" onclick="saveGrade(2)">2</button>
            <button class="num-btn val-3" onclick="saveGrade(3)">3</button>
            <button class="num-btn val-4" onclick="saveGrade(4)">4</button>
            <button class="num-btn val-5" onclick="saveGrade(5)">5</button>
            <button class="num-btn val-0" onclick="saveGrade(0)">‚óè</button>
        </div>
        <button class="btn" style="background:transparent" onclick="closeM('m-grade')">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

    let db = { subjects: [] };
    let curSubjId = null;

    // --- CLOUD STORAGE LOGIC ---

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    function initApp() {
        console.log("–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–ª–∞–∫–∞...");
        tg.CloudStorage.getItem('school_db_v4', (err, value) => {
            const loader = document.getElementById('loader');
            if (err) {
                alert("–û—à–∏–±–∫–∞ –æ–±–ª–∞–∫–∞: " + err);
                loader.style.display = 'none';
                return;
            }
            
            if (value) {
                try {
                    db = JSON.parse(value);
                    console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON");
                }
            } else {
                console.log("–û–±–ª–∞–∫–æ –ø—É—Å—Ç–æ–µ, –Ω–∞—á–∏–Ω–∞–µ–º —Å –Ω—É–ª—è");
            }
            
            renderHome();
            loader.style.display = 'none';
        });
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–æ
    function saveToCloud() {
        const jsonStr = JSON.stringify(db);
        document.getElementById('sync-status').innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        
        tg.CloudStorage.setItem('school_db_v4', jsonStr, (err, stored) => {
            if (err) {
                document.getElementById('sync-status').innerText = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚ùå";
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ!");
            } else {
                if (stored) {
                    document.getElementById('sync-status').innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ ‚úÖ";
                    setTimeout(() => {
                         document.getElementById('sync-status').innerText = "–û–±–ª–∞–∫–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ ‚óè";
                    }, 2000);
                }
            }
        });
    }

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª –Ω–∞ –ü–ö, –∞ –ø–æ—Ç–æ–º –∏–∑–º–µ–Ω–∏–ª –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)
    function forceSync() {
        location.reload();
    }
    
    function wipeCloud() {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞ –Ω–∞–≤—Å–µ–≥–¥–∞?")) {
            tg.CloudStorage.removeItem('school_db_v4', (err, deleted) => {
                if(deleted) location.reload();
            });
        }
    }

    // --- APP LOGIC ---

    function addSubject() {
        const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:");
        if(!n) return;
        db.subjects.push({ id: Date.now(), name: n, grades: [] });
        saveToCloud();
        renderHome();
    }

    function renderHome() {
        const c = document.getElementById('subjects-container');
        c.innerHTML = "";
        
        if(db.subjects.length === 0) {
            c.innerHTML = "<div style='text-align:center; padding:40px; color:#555'>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç.<br>–ù–∞–∂–º–∏ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç.</div>";
            return;
        }

        db.subjects.sort((a,b) => a.id - b.id).forEach(s => {
            // –†–∞—Å—á–µ—Ç
            const realGrades = s.grades.filter(g => g.v > 0);
            const sum = realGrades.reduce((a,b)=>a+b.v, 0);
            const avg = realGrades.length ? (sum / realGrades.length).toFixed(2) : 0;
            
            // –î–æ–ª–≥–∏
            const dots = s.grades.filter(g => g.v === 0).length;
            const alert = dots > 0 ? `<span style="color:var(--error); font-size:12px; margin-left:10px;">–î–æ–ª–≥–æ–≤: ${dots}</span>` : "";

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ü–µ–Ω–æ–∫
            let gHtml = s.grades.map((g, idx) => {
                const txt = g.v === 0 ? "‚óè" : g.v;
                return `<div class="grade-chip val-${g.v}" onclick="delGrade(${s.id}, ${idx})">${txt}</div>`;
            }).join('');

            c.innerHTML += `
            <div class="card">
                <div class="subj-header">
                    <div class="subj-name">${s.name} ${alert}</div>
                    <div class="subj-avg">${avg || "-"}</div>
                </div>
                <div class="grades-grid">${gHtml}</div>
                <button class="btn" onclick="openAdd(${s.id})" style="font-size:12px; padding:8px;">+ –û—Ü–µ–Ω–∫–∞</button>
                <button class="btn btn-danger" onclick="delSubj(${s.id})" style="font-size:12px; padding:8px; margin-top:5px;">–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
            </div>`;
        });
    }

    function openAdd(id) { curSubjId = id; document.getElementById('m-grade').style.display='flex'; }
    
    function saveGrade(val) {
        const s = db.subjects.find(x=>x.id===curSubjId);
        s.grades.push({ v: val, d: Date.now() }); // –ü—Ä–æ—Å—Ç–æ —Ö—Ä–∞–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –¥–∞—Ç—É
        saveToCloud();
        renderHome();
        closeM('m-grade');
    }

    function delGrade(sid, idx) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ü–µ–Ω–∫—É?")) {
            const s = db.subjects.find(x=>x.id===sid);
            s.grades.splice(idx, 1);
            saveToCloud();
            renderHome();
        }
    }

    function delSubj(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç —Ü–µ–ª–∏–∫–æ–º?")) {
            db.subjects = db.subjects.filter(x => x.id !== id);
            saveToCloud();
            renderHome();
        }
    }

    function nav(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('fab-add').style.display = (id==='home')?'flex':'none';
    }

    function closeM(id) { document.getElementById(id).style.display='none'; }

    // –ó–ê–ü–£–°–ö
    // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ API —Ç–µ–ª–µ–≥—Ä–∞–º–∞
    if (window.Telegram.WebApp.initData) {
        initApp();
    } else {
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
        alert("–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram! –û—Ç–∫—Ä–æ–π –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.");
        document.getElementById('loader').innerHTML = "–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram";
    }

</script>
</body>
</html>